---
// P√°gina de prueba de conexi√≥n a Supabase
// Accede a: http://localhost:4321/test-connection
---

<html>
<head>
  <title>Test de Conexi√≥n - Supabase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
    pre {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h1>üîç Test de Conexi√≥n a Supabase</h1>
  
  <div class="test-section">
    <h2>1. Variables de Entorno</h2>
    <div id="env-test">
      <p>Cargando...</p>
    </div>
  </div>

  <div class="test-section">
    <h2>2. Conexi√≥n a Supabase</h2>
    <div id="connection-test">
      <p>Cargando...</p>
    </div>
  </div>

  <div class="test-section">
    <h2>3. Consulta a Base de Datos (sin auth)</h2>
    <button onclick="testQuery()">Probar Consulta</button>
    <div id="query-test">
      <p>Haz clic en "Probar Consulta" para verificar acceso a la base de datos</p>
    </div>
  </div>

  <div class="test-section">
    <h2>4. Test de Autenticaci√≥n</h2>
    <div>
      <input type="email" id="test-email" placeholder="Email" value="admin@servicio.com" style="padding: 8px; width: 200px; margin: 5px;">
      <span style="position: relative; display: inline-block;">
        <input type="password" id="test-password" placeholder="Password" value="12345678" style="padding: 8px 32px 8px 8px; width: 200px; margin: 5px;">
        <button type="button" id="toggle-test-password" aria-label="Mostrar contrase√±a" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: transparent; cursor: pointer;">üëÅÔ∏è</button>
      </span>
      <button onclick="testAuth()">Probar Login</button>
    </div>
    <div id="auth-test">
      <p>Ingresa credenciales y haz clic en "Probar Login"</p>
    </div>
  </div>

  <script>
    (async function() {
      const passwordInput = document.getElementById('test-password');
      const toggleBtn = document.getElementById('toggle-test-password');
      if (passwordInput && toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          const isPassword = passwordInput.getAttribute('type') === 'password';
          passwordInput.setAttribute('type', isPassword ? 'text' : 'password');
          toggleBtn.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
          toggleBtn.setAttribute('aria-label', isPassword ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a');
        });
      }
      // Importar Supabase din√°micamente
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');

      // 1. Verificar variables de entorno
      const url = import.meta.env.PUBLIC_SUPABASE_URL;
      const anon = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

      const envDiv = document.getElementById('env-test');
      if (url && anon) {
        envDiv.innerHTML = `
          <p class="success">‚úÖ Variables de entorno configuradas</p>
          <p><strong>URL:</strong> ${url}</p>
          <p><strong>Anon Key:</strong> ${anon.substring(0, 20)}...${anon.substring(anon.length - 10)}</p>
        `;
      } else {
        envDiv.innerHTML = `
          <p class="error">‚ùå Variables de entorno NO configuradas</p>
          <p>URL: ${url ? '‚úÖ' : '‚ùå'}</p>
          <p>Anon Key: ${anon ? '‚úÖ' : '‚ùå'}</p>
          <p>Crea el archivo .env.local con PUBLIC_SUPABASE_URL y PUBLIC_SUPABASE_ANON_KEY</p>
        `;
        return;
      }

      // 2. Crear cliente Supabase
      let supabase;
      try {
        supabase = createClient(url, anon);
        const connectionDiv = document.getElementById('connection-test');
        connectionDiv.innerHTML = `
          <p class="success">‚úÖ Cliente de Supabase creado correctamente</p>
          <p>URL: ${url}</p>
        `;
      } catch (error) {
        const connectionDiv = document.getElementById('connection-test');
        connectionDiv.innerHTML = `
          <p class="error">‚ùå Error al crear cliente: ${error.message}</p>
        `;
        return;
      }

      // 3. Funci√≥n para probar consulta (global)
      window.testQuery = async function() {
        const queryDiv = document.getElementById('query-test');
        queryDiv.innerHTML = '<p class="info">Probando consulta...</p>';

        try {
          // Intentar consultar una tabla p√∫blica (branches)
          const { data, error } = await supabase
            .from('branches')
            .select('id, name')
            .limit(1);

          if (error) {
            queryDiv.innerHTML = `
              <p class="error">‚ùå Error en consulta:</p>
              <pre>${JSON.stringify(error, null, 2)}</pre>
              <p><strong>Esto indica:</strong> ${error.message.includes('RLS') ? 'Problema con Row Level Security (RLS)' : 'Problema de conexi√≥n o permisos'}</p>
            `;
          } else {
            queryDiv.innerHTML = `
              <p class="success">‚úÖ Conexi√≥n a base de datos EXITOSA</p>
              <p>Se pudo consultar la tabla 'branches'</p>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
          }
        } catch (err) {
          queryDiv.innerHTML = `
            <p class="error">‚ùå Error de conexi√≥n:</p>
            <pre>${err.message}</pre>
          `;
        }
      };

      // 4. Funci√≥n para probar autenticaci√≥n (global)
      window.testAuth = async function() {
        const authDiv = document.getElementById('auth-test');
        const email = document.getElementById('test-email').value;
        const password = document.getElementById('test-password').value;

        authDiv.innerHTML = '<p class="info">Probando autenticaci√≥n...</p>';

        try {
          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
          });

          if (error) {
            authDiv.innerHTML = `
              <p class="error">‚ùå Error de autenticaci√≥n:</p>
              <pre>${JSON.stringify(error, null, 2)}</pre>
              <p><strong>Mensaje:</strong> ${error.message}</p>
              <p><strong>Status:</strong> ${error.status}</p>
              <p><strong>Nombre:</strong> ${error.name}</p>
            `;
          } else {
            authDiv.innerHTML = `
              <p class="success">‚úÖ Autenticaci√≥n EXITOSA</p>
              <p>Usuario: ${data.user?.email}</p>
              <p>ID: ${data.user?.id}</p>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
          }
        } catch (err) {
          authDiv.innerHTML = `
            <p class="error">‚ùå Error inesperado:</p>
            <pre>${err.message}</pre>
          `;
        }
      };

      // Auto-ejecutar test de conexi√≥n
      setTimeout(() => {
        if (supabase) {
          window.testQuery();
        }
      }, 500);
    })();
  </script>
</body>
</html>
